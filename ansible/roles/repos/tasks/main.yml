---

- name: Remove repos (backward compatibility)
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop:
    - /etc/apt/sources.list.d/download_docker_com_linux_ubuntu.list
    - /etc/apt/sources.list.d/ubuntu.sources
  tags:
    - repos-absent
    - repos

- name: Copy repository list files
  ansible.builtin.copy:
    src: "{{ item }}"
    dest: "/etc/apt/sources.list.d/{{ item }}"
    owner: root
    group: root
    mode: '0644'
  loop:
    - nebius-ubuntu-security.sources
    - nebius-ubuntu-updates.sources
    - nebius-ubuntu.sources
    - nvidia-container-toolkit.list
    - quentiumyt-ubuntu-nvtop-noble.sources
  tags:
    - nvidia-container-toolkit-repo
    - repos

- name: Download Nebius public GPG key
  ansible.builtin.get_url:
    url: https://dr.nebius.cloud/public.gpg
    dest: /usr/share/keyrings/nebius.gpg.pub
    mode: "0644"
    checksum: "sha256:e4ec7915ef64976047b3a65db93cbfa94072a8179e77e29ea78f379d30bf4030"
  tags:
    - nebius-repo
    - repos

- name: Add Nebius APT repository
  ansible.builtin.copy:
    dest: /etc/apt/sources.list.d/nebius.list
    content: |
      deb [signed-by=/usr/share/keyrings/nebius.gpg.pub] https://dr.nebius.cloud/ {{ ansible_distribution_release }} main
      deb [signed-by=/usr/share/keyrings/nebius.gpg.pub] https://dr.nebius.cloud/ stable main
    owner: root
    group: root
    mode: "0644"
  tags:
    - nebius-repo
    - repos

- name: Add docker apt key
  ansible.builtin.get_url:
    url: https://download.docker.com/linux/ubuntu/gpg
    dest: /etc/apt/keyrings/docker.asc
    checksum: "sha256:1500c1f56fa9e26b9b8f42452a553675796ade0807cdce11975eb98170b3a570"
    mode: "0644"
  tags:
    - docker-repo
    - repos

- name: Add Docker APT repository
  ansible.builtin.deb822_repository:
    name: docker
    types: [deb]
    uris: https://download.docker.com/linux/ubuntu
    suites: ["{{ ansible_distribution_release }}"]
    components: [stable]
    signed_by: /etc/apt/keyrings/docker.asc
    state: present
  tags:
    - docker-repo
    - repos

- name: Download and convert NVIDIA GPG key
  ansible.builtin.shell: |
    set -o pipefail
    curl -fsSL https://nvidia.github.io/libnvidia-container/gpgkey \
    | gpg --dearmor -o /usr/share/keyrings/nvidia-container-toolkit-keyring.gpg
  args:
    executable: /bin/bash
    creates: /usr/share/keyrings/nvidia-container-toolkit-keyring.gpg
  tags:
    - nvidia-container-toolkit-repo
    - repos

- name: Configure ofed repositories
  ansible.builtin.template:
    src: mellanox_mlnx_ofed.list.j2
    dest: /etc/apt/sources.list.d/mellanox_mlnx_ofed.list
    mode: "0644"
  tags:
    - openmpi-repo
    - repos

- name: Add mellanox gpg key
  ansible.builtin.apt_key:
    url: https://www.mellanox.com/downloads/ofed/RPM-GPG-KEY-Mellanox
    keyring: /etc/apt/trusted.gpg
  tags:
    - openmpi-repo
    - repos

- name: Build CUDA keyring URL
  vars:
    _distro: "ubuntu{{ ansible_distribution_version | replace('.', '') }}"
    _arch: "{{ repos_cuda_dpkg_arch_map[ansible_architecture] }}"
  ansible.builtin.set_fact:
    repos_cuda_keyring_url: "https://developer.download.nvidia.com/compute/cuda/repos/{{ _distro }}/{{ _arch }}/cuda-keyring_1.1-1_all.deb"
    repos_cuda_keyring_path: "/tmp/cuda-keyring_1.1-1_all.deb"
  tags:
    - repos
    - cuda-repo

- name: Check if CUDA keyring .deb already exists
  ansible.builtin.stat:
    path: "{{ repos_cuda_keyring_path }}"
  register: repos_cuda_keyring_stat
  tags:
    - repos
    - cuda-repo

- name: Would download CUDA keyring (check-mode)
  ansible.builtin.debug:
    msg: "Would download {{ repos_cuda_keyring_url }} -> {{ repos_cuda_keyring_path }}"
  when: ansible_check_mode and not repos_cuda_keyring_stat.stat.exists
  tags:
    - repos
    - cuda-repo

- name: Would install CUDA keyring (check-mode)
  ansible.builtin.debug:
    msg: "Would install {{ repos_cuda_keyring_path }}"
  when: ansible_check_mode
  tags:
    - repos
    - cuda-repo

- name: Download NVIDIA CUDA keyring package
  ansible.builtin.get_url:
    url: "{{ repos_cuda_keyring_url }}"
    dest: "{{ repos_cuda_keyring_path }}"
    mode: "0644"
    force: false
    checksum: "{{ repos_cuda_sha256_map[ansible_architecture] }}"
  when: not ansible_check_mode
  tags:
    - repos
    - cuda-repo

- name: Install NVIDIA CUDA keyring package
  ansible.builtin.apt:
    deb: "{{ repos_cuda_keyring_path }}"
    state: present
  when: not ansible_check_mode
  tags:
    - repos
    - cuda-repo
