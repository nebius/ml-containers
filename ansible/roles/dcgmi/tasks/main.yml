---

- name: Detect CUDA toolkit version with nvcc
  ansible.builtin.shell: "/usr/local/cuda/bin/nvcc -V"
  args:
    executable: /bin/bash
  register: dcgmi_nvcc_version
  changed_when: false
  failed_when: false
  check_mode: false
  tags:
    - dcgmi

- name: Ensure nvcc command succeeded
  ansible.builtin.assert:
    that:
      - dcgmi_nvcc_version.rc == 0
    fail_msg: >-
      Failed to run 'nvcc -V' to detect CUDA version. Please ensure the CUDA
      toolkit is installed and 'nvcc' is in PATH.
  tags:
    - dcgmi

- name: Extract CUDA major version from nvcc output
  ansible.builtin.set_fact:
    dcgmi_cuda_major_version: >-
      {{ (dcgmi_nvcc_version.stdout | regex_findall('release ([0-9]+)'))[0] | string }}
  tags:
    - dcgmi

- name: Debug detected CUDA major version
  ansible.builtin.debug:
    var: dcgmi_cuda_major_version
  tags:
    - dcgmi

- name: Determine dcgmi packages from map
  ansible.builtin.set_fact:
    dcgmi_packages: "{{ dcgmi_cuda_packages_map.get(dcgmi_cuda_major_version, '') }}"
  tags:
    - dcgmi

- name: Fail if CUDA major version is not supported by dcgmi_cuda_packages_map
  ansible.builtin.assert:
    that:
      - dcgmi_packages | length > 0
    fail_msg: >-
      Detected CUDA major version '{{ dcgmi_cuda_major_version | default('UNKNOWN') }}',
      but dcgmi_cuda_packages_map has no entry for it. Please add one in
      roles/dcgmi/defaults/main.yml.
  tags:
    - dcgmi

- name: Remove old dcgmi packages
  ansible.builtin.apt:
    name: "{{ dcgmi_cuda_packages_map[dcgmi_cuda_old_version] }}"
    state: absent
    purge: true
    autoremove: true
    update_cache: false
    force_apt_get: true
  when: dcgmi_cuda_old_version is defined
  tags:
    - dcgmi

- name: Ensure dcgmi packages is installed for detected CUDA {{ dcgmi_cuda_major_version }}
  ansible.builtin.apt:
    name: "{{ dcgmi_packages }}"
    state: present
    update_cache: true
  tags:
    - dcgmi
